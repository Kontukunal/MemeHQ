<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meme Analytics | MemeHub</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/analytics.css" />
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="logo">
          <i class="fas fa-fire"></i>
          <span>MemeHQ</span>
        </div>
        <nav class="nav-menu">
          <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a href="create.html" class="nav-item auth-required">
            <i class="fas fa-plus-circle"></i>
            <span>Create Meme</span>
          </a>
          <a href="analytics.html" class="nav-item auth-required active">
            <i class="fas fa-chart-line"></i>
            <span>Analytics</span>
          </a>
          <a href="leaderboard.html" class="nav-item">
            <i class="fas fa-trophy"></i>
            <span>Leaderboard</span>
          </a>
          <a href="badges.html" class="nav-item auth-required">
            <i class="fas fa-medal"></i>
            <span>My Badges</span>
          </a>
        </nav>

        <!-- Theme Toggle -->
        <button id="themeToggle" class="theme-toggle" title="Toggle theme">
          <i class="fas fa-moon"></i>
        </button>

        <div class="user-profile">
          <img
            src="https://ui-avatars.com/api/?name=U"
            alt="User"
            id="userAvatar"
            class="user-avatar"
          />
          <div class="user-info">
            <span id="userName">Guest</span>
            <button id="logoutBtn" class="logout-btn">
              <i class="fas fa-sign-out-alt"></i> Logout
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <header class="top-bar">
          <h1>Meme Analytics</h1>
          <div class="time-filter">
            <button class="btn btn-secondary active" data-period="24h">
              24h
            </button>
            <button class="btn btn-secondary" data-period="7d">7d</button>
            <button class="btn btn-secondary" data-period="30d">30d</button>
            <button class="btn btn-secondary" data-period="all">
              All Time
            </button>
          </div>
        </header>

        <div class="analytics-container">
          <!-- Meme Overview Section -->
          <div class="analytics-section">
            <h2><i class="fas fa-chart-pie"></i> Meme Overview</h2>
            <div class="meme-overview">
              <div class="meme-preview">
                <img
                  id="memeImage"
                  src=""
                  alt="Meme Preview"
                  class="meme-image"
                />
                <h3 id="memeTitle">Loading...</h3>
              </div>
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="fas fa-eye"></i>
                  </div>
                  <div class="stat-value" id="totalViews">0</div>
                  <div class="stat-label">Total Views</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="fas fa-thumbs-up"></i>
                  </div>
                  <div class="stat-value" id="totalLikes">0</div>
                  <div class="stat-label">Total Likes</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="fas fa-comment"></i>
                  </div>
                  <div class="stat-value" id="totalComments">0</div>
                  <div class="stat-label">Total Comments</div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                  </div>
                  <div class="stat-value" id="engagementRate">0</div>
                  <div class="stat-label">Engagement Rate</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Performance Rating -->
          <div class="analytics-section">
            <h2><i class="fas fa-star"></i> Performance Rating</h2>
            <div class="performance-rating">
              <div class="rating-icon">
                <i class="fas fa-trophy"></i>
              </div>
              <div class="rating-content">
                <div id="performanceRating" class="rating">-</div>
                <div
                  id="performanceDescription"
                  class="performance-description"
                >
                  Loading performance analysis...
                </div>
              </div>
            </div>
          </div>

          <!-- Engagement Charts -->
          <div class="analytics-section">
            <h2><i class="fas fa-chart-bar"></i> Engagement Analytics</h2>
            <div class="chart-container">
              <div class="chart-header">
                <h3>Engagement Breakdown</h3>
                <div class="chart-legend">
                  <span class="legend-item"
                    ><span class="legend-color likes"></span> Likes</span
                  >
                  <span class="legend-item"
                    ><span class="legend-color comments"></span> Comments</span
                  >
                  <span class="legend-item"
                    ><span class="legend-color views"></span> Views</span
                  >
                </div>
              </div>
              <canvas id="engagementChart"></canvas>
            </div>

            <div class="chart-container">
              <div class="chart-header">
                <h3>Performance Over Time</h3>
                <div class="time-filter">
                  <button class="time-btn active" data-period="24h">24h</button>
                  <button class="time-btn" data-period="7d">7d</button>
                  <button class="time-btn" data-period="30d">30d</button>
                  <button class="time-btn" data-period="all">All Time</button>
                </div>
              </div>
              <canvas id="historicalChart"></canvas>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="analytics-section">
            <h2><i class="fas fa-history"></i> Recent Activity</h2>
            <div class="activity-list" id="recentActivity"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="module">
      import { auth, db } from "./scripts/firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        doc,
        getDoc,
        collection,
        query,
        where,
        orderBy,
        limit,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { showToast, formatDate } from "./scripts/utils.js";
      import { handleLogout } from "./scripts/auth.js";
      import { initTheme, toggleTheme } from "./scripts/theme.js";

      // Initialize theme
      initTheme();

      // DOM Elements - declare them one per line to avoid syntax errors
      const memeImage = document.getElementById("memeImage");
      const memeTitle = document.getElementById("memeTitle");
      const totalViews = document.getElementById("totalViews");
      const totalLikes = document.getElementById("totalLikes");
      const totalComments = document.getElementById("totalComments");
      const engagementRate = document.getElementById("engagementRate");
      const performanceRating = document.getElementById("performanceRating");
      const performanceDescription = document.getElementById(
        "performanceDescription"
      );
      const recentActivity = document.getElementById("recentActivity");
      const timeFilterBtns = document.querySelectorAll(".time-filter button");
      const logoutBtn = document.getElementById("logoutBtn");
      const themeToggle = document.getElementById("themeToggle");

      // Chart instances
      let engagementChart, historicalChart;
      let currentMemeId,
        currentPeriod = "24h";

      // Initialize the page
      async function initializePage() {
        console.log("Initializing analytics page...");

        // Set up event listeners
        setupEventListeners();

        // Check authentication state with timeout
        const user = await checkAuthState();
        if (!user) return;

        // Get meme ID from URL
        currentMemeId = getMemeIdFromUrl();
        if (!currentMemeId) return;

        // Verify meme ownership
        const memeData = await verifyMemeOwnership(currentMemeId, user.uid);
        if (!memeData) return;

        // Load and display analytics data
        await loadAndDisplayAnalytics(currentMemeId, currentPeriod);
      }

      // Check authentication state with timeout
      async function checkAuthState() {
        try {
          console.log("Checking authentication state...");

          // Use Promise.race to implement timeout
          const user = await Promise.race([
            new Promise((resolve) => {
              const unsubscribe = onAuthStateChanged(auth, (user) => {
                unsubscribe();
                console.log(
                  "Auth state resolved:",
                  user ? "Authenticated" : "Not authenticated"
                );
                resolve(user);
              });
            }),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error("Auth check timeout")), 3000)
            ),
          ]);

          if (!user) {
            console.log("User not authenticated, redirecting to login");
            sessionStorage.setItem("redirectTo", window.location.href);
            window.location.href = "login.html";
            return null;
          }
          return user;
        } catch (error) {
          console.error("Authentication check error:", error);
          showToast("Authentication check failed", "error");
          window.location.href = "index.html";
          return null;
        }
      }

      // Get meme ID from URL
      function getMemeIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const memeId = urlParams.get("id");

        if (!memeId) {
          console.log("No meme ID found in URL");
          showToast("No meme specified", "error");
          window.location.href = "index.html";
          return null;
        }

        console.log("Found meme ID in URL:", memeId);
        return memeId;
      }

      // Verify meme ownership
      async function verifyMemeOwnership(memeId, userId) {
        try {
          console.log("Verifying meme ownership...");
          const memeRef = doc(db, "memes", memeId);
          const memeSnap = await getDoc(memeRef);

          if (!memeSnap.exists()) {
            console.log("Meme document does not exist");
            showToast("Meme not found", "error");
            window.location.href = "index.html";
            return null;
          }

          if (memeSnap.data().userId !== userId) {
            console.log("User is not the owner of this meme");
            showToast(
              "You can only view analytics for your own memes",
              "error"
            );
            window.location.href = "index.html";
            return null;
          }

          console.log("Meme ownership verified successfully");
          return {
            id: memeSnap.id,
            ...memeSnap.data(),
            createdAt: memeSnap.data().createdAt?.toDate(),
          };
        } catch (error) {
          console.error("Error verifying meme ownership:", error);
          showToast("Error verifying meme ownership", "error");
          window.location.href = "index.html";
          return null;
        }
      }

      // Load and display analytics data
      async function loadAndDisplayAnalytics(memeId, period) {
        try {
          console.log("Loading analytics data...");

          // Load basic meme data
          const memeData = await getMemeData(memeId);
          if (!memeData) return;

          // Load historical data
          const historicalData = await getHistoricalData(memeId, period);

          // Load recent activity
          const activityData = await getRecentActivity(memeId);

          // Render all data
          renderMemeOverview(memeData);
          renderPerformanceRating(memeData);
          renderEngagementChart(memeData);
          renderHistoricalChart(historicalData);
          renderRecentActivity(activityData);

          console.log("Analytics data loaded successfully");
        } catch (error) {
          console.error("Error loading analytics data:", error);
          showToast("Failed to load analytics data", "error");
        }
      }

      // Set up event listeners
      function setupEventListeners() {
        // Time filter buttons
        timeFilterBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            timeFilterBtns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            currentPeriod = btn.dataset.period;
            loadAndDisplayAnalytics(currentMemeId, currentPeriod);
          });
        });

        // Logout button
        if (logoutBtn) {
          logoutBtn.addEventListener("click", handleLogout);
        }

        // Theme toggle
        if (themeToggle) {
          themeToggle.addEventListener("click", toggleTheme);
        }
      }

      // Load all analytics data
      async function loadAnalyticsData(memeId, period) {
        try {
          // Load basic meme data
          const memeData = await getMemeData(memeId);
          if (!memeData) return;

          // Load historical data
          const historicalData = await getHistoricalData(memeId, period);

          // Load recent activity
          const activityData = await getRecentActivity(memeId);

          // Render all data
          renderMemeOverview(memeData);
          renderPerformanceRating(memeData);
          renderEngagementChart(memeData);
          renderHistoricalChart(historicalData);
          renderRecentActivity(activityData);
        } catch (error) {
          console.error("Error loading analytics:", error);
          showToast("Failed to load analytics data", "error");
        }
      }

      // Get meme data from Firestore
      async function getMemeData(memeId) {
        try {
          const user = auth.currentUser;
          if (!user) {
            // No need to redirect here - auth.js handles it
            return null;
          }

          const memeRef = doc(db, "memes", memeId);
          const memeSnap = await getDoc(memeRef);

          if (!memeSnap.exists()) {
            showToast("Meme not found", "error");
            window.location.href = "index.html";
            return null;
          }

          // Verify ownership
          if (memeSnap.data().userId !== user.uid) {
            showToast(
              "You can only view analytics for your own memes",
              "error"
            );
            window.location.href = "index.html";
            return null;
          }

          return {
            id: memeSnap.id,
            ...memeSnap.data(),
            createdAt: memeSnap.data().createdAt?.toDate(),
          };
        } catch (error) {
          console.error("Error getting meme data:", error);
          showToast("Error loading meme data", "error");
          window.location.href = "index.html";
          return null;
        }
      }

      // Get historical engagement data
      async function getHistoricalData(memeId, period) {
        try {
          const now = new Date();
          let startDate = new Date();

          switch (period) {
            case "24h":
              startDate.setHours(now.getHours() - 24);
              break;
            case "7d":
              startDate.setDate(now.getDate() - 7);
              break;
            case "30d":
              startDate.setDate(now.getDate() - 30);
              break;
            case "all":
              startDate = new Date(0); // All time
              break;
          }

          const historyRef = collection(db, `memes/${memeId}/history`);
          const q = query(
            historyRef,
            where("date", ">=", startDate),
            orderBy("date", "asc")
          );

          const querySnapshot = await getDocs(q);

          // If no history records, create a basic one from current stats
          if (querySnapshot.empty) {
            const memeRef = doc(db, "memes", memeId);
            const memeSnap = await getDoc(memeRef);
            if (memeSnap.exists()) {
              return [
                {
                  date: memeSnap.data().createdAt?.toDate() || new Date(),
                  likes: memeSnap.data().likes || 0,
                  views: memeSnap.data().views || 0,
                  comments: memeSnap.data().commentCount || 0,
                },
              ];
            }
            return [];
          }

          return querySnapshot.docs.map((doc) => ({
            date: doc.data().date?.toDate(),
            likes: doc.data().likes || 0,
            views: doc.data().views || 0,
            comments: doc.data().comments || 0,
          }));
        } catch (error) {
          console.error("Error getting historical data:", error);
          return [];
        }
      }
      // Get recent activity (likes, comments)
      async function getRecentActivity(memeId) {
        try {
          // Get recent comments
          const commentsRef = collection(db, `memes/${memeId}/comments`);
          const commentsQuery = query(
            commentsRef,
            orderBy("createdAt", "desc"),
            limit(5)
          );
          const commentsSnapshot = await getDocs(commentsQuery);
          const comments = commentsSnapshot.docs.map((doc) => ({
            type: "comment",
            ...doc.data(),
            createdAt: doc.data().createdAt?.toDate(),
          }));

          // Get recent likes (you might need to adjust based on your data structure)
          const memeRef = doc(db, "memes", memeId);
          const memeSnap = await getDoc(memeRef);
          const likes =
            memeSnap
              .data()
              ?.likedBy?.slice(0, 5)
              .map((userId) => ({
                type: "like",
                userId,
                createdAt: new Date(), // Approximate time
              })) || [];

          // Combine and sort by date
          return [...comments, ...likes].sort(
            (a, b) => b.createdAt - a.createdAt
          );
        } catch (error) {
          console.error("Error getting recent activity:", error);
          return [];
        }
      }

      // Render meme overview section
      function renderMemeOverview(memeData) {
        memeImage.src = memeData.imageUrl;
        memeTitle.textContent = memeData.title || "Untitled Meme";

        // Format numbers
        const formatNumber = (num) => {
          if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
          if (num >= 1000) return `${(num / 1000).toFixed(1)}k`;
          return num.toString();
        };

        totalViews.textContent = formatNumber(memeData.views || 0);
        totalLikes.textContent = formatNumber(memeData.likes || 0);
        totalComments.textContent = formatNumber(memeData.commentCount || 0);

        // Calculate engagement rate (likes per 1000 views)
        const rate =
          memeData.views > 0
            ? ((memeData.likes / memeData.views) * 1000).toFixed(1)
            : 0;
        engagementRate.textContent = rate;
      }

      // Render performance rating
      function renderPerformanceRating(memeData) {
        // Calculate hours since creation
        const hoursSinceCreation = Math.max(
          1,
          (new Date() - memeData.createdAt) / (1000 * 60 * 60)
        );

        // Calculate metrics
        const likesPerHour = (memeData.likes || 0) / hoursSinceCreation;
        const commentsPerHour =
          (memeData.commentCount || 0) / hoursSinceCreation;
        const engagementRate =
          memeData.views > 0 ? (memeData.likes / memeData.views) * 100 : 0;

        let rating, className, description;

        if (likesPerHour > 10 || engagementRate > 15) {
          rating = "Viral";
          className = "viral";
          description =
            "🔥 Your meme is on fire! It's getting exceptional engagement.";
        } else if (likesPerHour > 5 || engagementRate > 8) {
          rating = "Great";
          className = "great";
          description = "👍 Performing better than 80% of memes. Keep it up!";
        } else if (likesPerHour > 2 || engagementRate > 3) {
          rating = "Good";
          className = "good";
          description = "💪 Solid performance. Try optimizing posting time.";
        } else if (likesPerHour > 0.5 || engagementRate > 1) {
          rating = "Average";
          className = "average";
          description =
            "🤔 Getting some traction. Consider improving your tags.";
        } else {
          rating = "Low";
          className = "low";
          description =
            "📉 Needs improvement. Try different content or audience.";
        }

        performanceRating.textContent = rating;
        performanceRating.className = `rating ${className}`;
        performanceDescription.innerHTML = `
    ${description}<br><br>
    <small>
      Stats: ${Math.round(likesPerHour * 10) / 10} likes/hour • 
      ${engagementRate.toFixed(1)}% engagement
    </small>
  `;
      }
      // Render engagement chart
      function renderEngagementChart(memeData) {
        const ctx = document.getElementById("engagementChart").getContext("2d");

        if (engagementChart) {
          engagementChart.destroy();
        }

        engagementChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Likes", "Comments", "Views"],
            datasets: [
              {
                data: [
                  memeData.likes || 0,
                  memeData.commentCount || 0,
                  memeData.views || 0,
                ],
                backgroundColor: ["#4CAF50", "#2196F3", "#FF9800"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) =>
                    `${context.label}: ${context.raw.toLocaleString()}`,
                },
              },
            },
            cutout: "70%",
          },
        });
      }

      // Render historical chart
      function renderHistoricalChart(historicalData) {
        const ctx = document.getElementById("historicalChart").getContext("2d");

        if (historicalChart) {
          historicalChart.destroy();
        }

        if (historicalData.length < 2) {
          document
            .getElementById("historicalChart")
            .closest(".chart-container").style.display = "none";
          return;
        }

        historicalChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: historicalData.map((data) =>
              formatDate(data.timestamp, true)
            ),
            datasets: [
              {
                label: "Likes",
                data: historicalData.map((data) => data.likes),
                borderColor: "#4CAF50",
                backgroundColor: "rgba(76, 175, 80, 0.1)",
                tension: 0.3,
                fill: true,
              },
              {
                label: "Views",
                data: historicalData.map((data) => data.views),
                borderColor: "#FF9800",
                backgroundColor: "rgba(255, 152, 0, 0.1)",
                tension: 0.3,
                fill: true,
              },
              {
                label: "Comments",
                data: historicalData.map((data) => data.comments),
                borderColor: "#2196F3",
                backgroundColor: "rgba(33, 150, 243, 0.1)",
                tension: 0.3,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) =>
                    value >= 1000 ? `${value / 1000}k` : value,
                },
              },
            },
          },
        });
      }

      // Render recent activity
      function renderRecentActivity(activities) {
        if (activities.length === 0) {
          recentActivity.innerHTML =
            '<div class="empty-state">No recent activity yet</div>';
          return;
        }

        recentActivity.innerHTML = activities
          .map((activity) => {
            if (activity.type === "comment") {
              return `
                <div class="activity-item">
                  <i class="fas fa-comment"></i>
                  <div class="activity-content">
                    <strong>${activity.author}</strong> commented: "${
                activity.text
              }"
                    <small>${formatDate(activity.createdAt)}</small>
                  </div>
                </div>
              `;
            } else {
              return `
                <div class="activity-item">
                  <i class="fas fa-heart"></i>
                  <div class="activity-content">
                    <strong>User ${activity.userId.slice(
                      0,
                      6
                    )}</strong> liked your meme
                    <small>${formatDate(activity.createdAt)}</small>
                  </div>
                </div>
              `;
            }
          })
          .join("");
      }
    </script>
  </body>
</html>
